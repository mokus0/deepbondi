#!/usr/bin/perl
#
#  <cabalTemplate>
#    Copyright 2008 James Cook - All Rights Reserved.
#
#

use strict;

my ($file) = @ARGV;

my $year = `date +%Y`;
chomp $year;

my $fullName = `fullName -n`;

open DIRNAME, "-|", "dirname", $file or die "Can't open dirname command";
my $dirname = <DIRNAME>;
chomp $dirname;
close DIRNAME;

if (! defined $file) {
    $file = `basename \`pwd\``;
    chomp $file;
}

my $noExt = $file;
$noExt =~ s/\.cabal$//i;

if ($noExt eq $file) {
	$file = $file . ".cabal"
}

my $setup = "$dirname/Setup.lhs";
if (! -e $setup) {
        open SETUP, ">", $setup;
        
        print SETUP <<HASKELL;
#!/usr/bin/env runhaskell

> import Distribution.Simple
> main = defaultMain

HASKELL
        close SETUP;
}

my $srcDir = ".";

if (! -x "$dirname/src") {
    $srcDir = "src" if mkdir "$dirname/src";
}

if (-d "$dirname/src") {
    $srcDir = "src";
}

open OUTFILE, ">", $file;

print OUTFILE <<CABAL;
name:                   $noExt
version:                0.0.0.1
stability:              experimental

cabal-version:          >= 1.2
build-type:             Simple

author:                 $fullName <your email here>
maintainer:             $fullName <your email here>
license:                Unspecified
homepage:               /dev/null

category:               Unclassified
synopsis:               I'm too lame to describe my project
description:            I'm too lame to describe my project

Library
  hs-source-dirs:       $srcDir
  exposed-modules:      
  build-depends:        base >= 3
CABAL

close OUTFILE;

if (! -x "$dirname/_darcs") {
    my $cwd = `pwd`;
    chomp $cwd;
    
    chdir $dirname
    and (system "darcs", "initialize") == 0
    and open BORINGFILE, ">>", "_darcs/prefs/boring"
    and print BORINGFILE "(^|/)dist(/|\$)\n"
    and close BORINGFILE;
    
    chdir $cwd;
}

# warning; if extending here, be aware that the previous part
# only makes a very rudimentary effort to ensure that the PWD is unchanged.
